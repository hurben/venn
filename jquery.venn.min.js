/**
 * Copyright (C) 2012, Christopher Mullins ( chris.mullins10@gmail.com )
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a 
 * copy of this software and associated documentation files (the "Software"), 
 * to deal in the Software without restriction, including without limitation 
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, 
 * and/or sell copies of the Software, and to permit persons to whom the 
 * Software is furnished to do so, subject to the following conditions: 
 * 
 * The above copyright notice and this permission notice shall be included in 
 * all copies or substantial portions of the Software. 
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
 * DEALINGS IN THE SOFTWARE. 
 */
!function(t){function e(t,e){this.venn=t,this.data=t.data("venn"),this.settings=this.data.settings,this.containedSets=e,this.active=!1,this.shadingLines=null
var i=function(t,e){return t.data("index")-e.data("index")}
this.containedSets=this.containedSets.sort(i)}function i(){for(var t={},i=this.data("venn"),n=i.set,r=i.settings,a=.05*Math.max(i.bbox.width,r.canvasWidth),s=0;s<this.width();s+=a)for(var o=0;o<this.height();o+=a){var h=s+a,c=o+a,v=l(h,c,n),d=e.getHashKey(v)
t[d]=[h,c]}return t}function n(t,i){if(0==i.length)return[new e(t,[])]
var r=n(t,i.slice(1)),a=[]
for(var s in r)a.push(r[s]),a.push(r[s].union([i[0]]))
return a}function r(t,e,i){var n=.3*t.canvasWidth/2,r=t.canvasWidth/2,a=t.canvasHeight/2,s=[e.ellipse(r-n/2,a,n,n),e.ellipse(r+n/2,a,n,n)]
for(var o in s){var h=s[o]
h.attr("stroke",t.colors[o]).data("index",o)
for(var l in t.ellipseSettings)h.attr(l,t.ellipseSettings[l])
var c,v,d=h.attr("cx"),g=h.attr("cy")
0==o?(c=d-.75*n,v=g):(c=d+.75*n,v=g)
var f=e.text(c,v,t.setLabels[o]).attr("font-size","10").attr("font-weight","bold"),u=f.getBBox()
e.rect(u.x-4,u.y-2,u.width+8,u.height+4).attr("fill",t.backgroundColor).attr("stroke-width",0).toBack()}return s}function a(t,e,i){var n=.32*t.canvasWidth/2,r=t.canvasWidth/2,a=t.canvasHeight/2+n/3,s=e.set(),o=[e.ellipse(r-n/2,a-.75*n,n,n),e.ellipse(r+n/2,a-.75*n,n,n),e.ellipse(r,a,n,n)],h=[]
for(var l in o){var c=o[l]
s.push(c),c.attr("stroke",t.colors[l]).data("index",l)
for(var v in t.ellipseSettings)c.attr(v,t.ellipseSettings[v])
var d,g,f=c.attr("cx"),u=c.attr("cy")
0==l?(d=f-n/2,g=u-n/2):1==l?(d=f+n/2,g=u-n/2):(d=f,g=u+.75*n)
var p=e.text(d,g,t.setLabels[l]).attr("font-size","10").attr("font-weight","bold").toBack(),y=p.getBBox(),x=e.rect(y.x-4,y.y-2,y.width+8,y.height+4).attr("fill",t.backgroundColor).attr("stroke-width",0).toBack()
s.push(p).push(x),h.push(e.set().push(p).push(x))}var b=s.getBBox(),k=b.x+b.width/2,S=b.y+b.height/2
s.rotate(90,k,S)
for(var l in h)h[l].rotate(-90)
return o}function s(t,e,i){var n=.1*t.canvasWidth,r=.25*t.canvasWidth,a=1.6*r+n,s=t.canvasHeight/2+1.25*n,o=[e.ellipse(a+r,s,n,r).rotate(-70,a,s+r),e.ellipse(a+r,s,n,r).rotate(-65,a,s+r).translate(r/3,n/2),e.ellipse(a-r,s,n,r).rotate(65,a,s+r).translate(-r/3,n/2),e.ellipse(a-r,s,n,r).rotate(70,a,s+r)]
for(var h in o){var l=o[h]
l.attr("stroke",t.colors[h]).data("index",h)
for(var c in t.ellipseSettings)l.attr(c,t.ellipseSettings[c])
var v,d,g=l.attr("cx"),f=l.attr("cy")-l.attr("ry")+20
0==h||3==h?(v=l.matrix.x(g,f),d=l.matrix.y(g,f)):2==h?(v=l.matrix.x(g,f)-30,d=l.matrix.y(g,f)-10):1==h&&(v=l.matrix.x(g,f)+30,d=l.matrix.y(g,f)-10)
var u=e.text(v,d,t.setLabels[h]).attr("font-size","10").attr("font-weight","bold").toBack(),p=u.getBBox()
e.rect(p.x-4,p.y-2,p.width+8,p.height+4).attr("fill",t.backgroundColor).attr("stroke-width",0).toBack()}return o}function o(){var t=this.data("venn"),e=t.settings,i="",n=t.regions[i]
e.disableClicks||(n.toggleActive(),e.shadeRegions&&x(0,0,[],this),this.trigger("regionClicked.venn",t.regions[i]))}function h(t){var i=t.hasOwnProperty("offsetX")?t.offsetX:t.layerX,n=t.hasOwnProperty("offsetY")?t.offsetY:t.layerY,r=this.data("venn"),a=r.set,s=l(i,n,a),o=e.getHashKey(s)
r.settings.disableClicks||(r.regions[o].toggleActive(),r.settings.shadeRegions&&x(i,n,s,this),this.trigger("regionClicked.venn",r.regions[o]))}function l(t,e,i){for(var n=[],r=0;r<i.length;r++)v(t,e,i[r])&&n.push(i[r])
return n}function c(t,e,i){var n=i.attr("cx"),r=i.attr("cy"),a=i.attr("rx"),s=i.attr("ry"),o=i.matrix.invert().x(t,e),h=i.matrix.invert().y(t,e),l=o-n,c=h-r
return l*l/(a*a)+c*c/(s*s)}function v(t,e,i){return c(t,e,i)<=1}function d(t,e,i){var n=Math.abs(c(t,e,i)-1)
return n<Math.abs(c(t-1,e,i)-1)&&n<Math.abs(c(t+1,e,i)-1)}function g(t,e,i){for(var n=0;n<i.length;n++){var r=i[n]
if(d(t,e,r))return n}return null}function f(t,e,i){for(var n=0;n<i.length;n++)if(c(t,e,i[n])>1)return!1
return!0}function u(t,e,i){for(var n=0;n<i.length;n++)if(c(t,e,i[n])<1)return!0
return!1}function p(t,e){for(var i in t)if(t[i].data("index")==e.data("index"))return!0
return!1}function y(t,e){for(var i=[],n=0;n<t.length;n++)p(e,t[n])||i.push(t[n])
return i}function x(t,i,n,r){var a=e.getHashKey(n),s=r.data("venn"),o=s.settings,h=s.set,l=s.bbox,c=o.shadeSpacing,v=s.paper,d=y(h,n)
if(s.regions[a].isActive())if(0==n.length)s.universe.attr("fill",o.shadeColor).attr("fill-opacity",o.universeShadeOpacity)
else{var p=[],x=[],b=[-c,c]
for(var k in b){var c=b[k],S=t,w=t,C=i
k>0&&(C+=c),p.length>0&&(S=x[0],w=x[0])
t:for(;;){for(;null==g(S-1,C,n)&&!u(S-1,C,d);)if(S--,S+10<l.x)break t
for(;null==g(w+1,C,n)&&!u(w+1,C,d);)if(w++,w-10>l.x+l.width)break t
if(!f(S,C,n)||!f(w,C,n)||u(S,C,d)||u(w,C,d))break t
p.push(v.path(Raphael.fullfill("M{startx},{starty}L{endx},{endy}",{startx:S,starty:C,endx:w,endy:C})).toBack()),S=Math.floor((w+S)/2),x.push(S),w=S,C+=c}}s.regions[a].shade(p)}else s.regions[a].unshade()}e.prototype.getHashKey=function(){return e.getHashKey(this.containedSets)},e.prototype.getArrayKey=function(){for(var t=[],e=0;e<this.containedSets.length;e++)t.push(this.containedSets[e].data("index"))
return t.sort()},e.prototype.getId=function(){var t=this.settings.setLabels,i=this.getArrayKey()
return e.arrayKeyToRegionLabel(i,t)},e.prototype.isActive=function(){return this.active},e.prototype.toggleActive=function(){this.setActive(!this.isActive())},e.prototype.setActive=function(t){this.active=t},e.prototype.unshade=function(){if(0==this.containedSets.length)this.data.universe.attr("fill-opacity",0)
else{if("undefined"!=typeof this.shadingLines&&null!=this.shadingLines)for(var t in this.shadingLines)this.shadingLines[t].remove()
this.shadingLines=null}},e.prototype.shade=function(t){this.shadingLines=t},e.prototype.union=function(t){var i=this.containedSets.slice()
for(var n in t)i.push(t[n])
return new e(this.venn,i)},e.prototype.toString=function(){return this.getId()},e.prototype.getRepresentativeCoords=function(){return this.data.regionCoordinates[this.getHashKey()]},e.getHashKey=function(t){var e=""
for(var i in t)e+=t[i].data("index")+","
return e},e.arrayKeyToRegionLabel=function(t,e){t=t.sort()
for(var i="",n=0;n<t.length;n++)i+=e[t[n]]
return i}
var b={init:function(e){var l=t.extend({numSets:4,setLabels:["A","B","C","D"],universeLabel:"U",colors:["#f00","#0f0","#00f","#dd0"],backgroundColor:"#fff",borderColor:"#000",shadeRegions:!0,shadeSpacing:3,shadeColor:"#000",universeShadeOpacity:.3,ellipseSettings:{fill:"#fff","fill-opacity":0,"stroke-width":2},initRegions:[],disableClicks:!1,canvasWidth:"inherit",canvasHeight:"inherit",regionClicked:t.noop},e)
"inherit"==l.canvasWidth&&(l.canvasWidth=this.width()),"inherit"==l.canvasHeight&&(l.canvasHeight=this.height())
var c,v=this,d=Raphael(t(this)[0],l.canvasWidth,l.canvasHeight)
c=4==l.numSets?s(l,d,this):3==l.numSets?a(l,d,this):r(l,d,this)
var g=d.set()
for(var f in c)g.push(c[f])
var u=g.getBBox(),p=20,y=d.rect(u.x-p,u.y-p,u.width+2*p,u.height+2*p).attr("fill",l.universeShadeOpacity).attr("fill-opacity",0).attr("stroke-width",1).toBack()
d.text(y.attr("x")+y.attr("width")-p/2,y.attr("y")+y.attr("height")-10,l.universeLabel).attr("font-size","10").attr("font-weight","bold").toBack(),g.click(function(t){h.apply(v,[t])}),y.click(function(t){o.apply(v)}),this.data("venn",{settings:l,paper:d,set:g,universe:y,bbox:u})
var x=n(this,t.makeArray(g)),b={}
for(var f in x)b[x[f].getHashKey()]=x[f]
this.data("venn").regionCoordinates=i.call(v),this.data("venn").regions=b,this.bind("regionClicked.venn",l.regionClicked),this.height()<l.canvasHeight&&this.height(l.canvasHeight)
for(f in l.initRegions)this.venn("activateRegion",l.initRegions[f])
return this},activeRegions:function(){var t=[],e=this.data("venn").regions
for(var i in e)e[i].isActive()&&t.push(e[i])
return t},activateRegion:function(t){var i=this.data("venn").settings,n=this.data("venn").regions
"object"==typeof t&&(t=e.arrayKeyToRegionLabel(t,i.setLabels))
for(var r in n)if(t==n[r].getId()&&!n[r].isActive()){n[r].toggleActive()
var a=n[r].getRepresentativeCoords()
i.shadeRegions&&x(a[0],a[1],n[r].containedSets,this)
break}return this}}
t.fn.venn=function(e){return b[e]?b[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void t.error("Method "+e+"does not exist on jQuery.venn!"):b.init.apply(this,arguments)}}(jQuery)
